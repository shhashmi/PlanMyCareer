openapi: 3.0.3
info:
  title: AI Fluency Assessment API
  description: |
    API for AI Fluency assessment platform. Allows users to take assessments,
    track progress, and view analytics.

    ## Authentication
    Most endpoints require authentication via JWT token stored in a cookie.
    Users authenticate via OAuth providers (Google, GitHub, LinkedIn).
  version: 1.0.0
  contact:
    name: API Support

servers:
  - url: http://localhost:8080
    description: Development server
  - url: https://api.aifluens.com
    description: Production server

tags:
  - name: Health
    description: Health check endpoints
  - name: Auth
    description: Authentication endpoints
  - name: Profile
    description: User profile management
  - name: Questions
    description: Question and metadata endpoints
  - name: Assessments
    description: Assessment session management
  - name: Reports
    description: Reporting and aggregate summaries
  - name: Fluency
    description: Fluency profile resolution
  - name: Email
    description: Email enquiry endpoints
  - name: Agent
    description: AI Assessment Agent (paid, SSE streaming)
  - name: AdvancedAssessments
    description: Advanced (agent-based) assessment management — eligibility, results, reset
  - name: StudyMaterial
    description: Study material content for paid users
  - name: Preview Access
    description: Request access to preview features

paths:
  /:
    get:
      tags:
        - Health
      summary: Welcome message
      responses:
        '200':
          description: Welcome message
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "AI Fluency API Server - Endpoint: POST /api/fluency/resolve"

  /health:
    get:
      tags:
        - Health
      summary: Health check
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"

  /api/v1/fluency/resolve:
    post:
      tags:
        - Fluency
      summary: Resolve fluency profile (v1)
      description: |
        Resolves a user's fluency profile based on their experience and role.
        **Deprecated:** Use v2 endpoint for priority information.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FluencyInput'
      responses:
        '200':
          description: Fluency profile resolved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FluencyProfileV1'
        '400':
          description: Missing required parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v2/fluency/resolve:
    post:
      tags:
        - Fluency
      summary: Resolve fluency profile (v2)
      description: |
        Resolves a user's fluency profile based on their experience and role.
        Includes priority ranking (1-10) for each dimension based on role and experience level.
        Lower priority number = higher importance for the role.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FluencyInput'
      responses:
        '200':
          description: Fluency profile resolved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FluencyProfileV2'
        '400':
          description: Missing required parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/login/{provider}:
    get:
      tags:
        - Auth
      summary: Initiate OAuth login
      description: Redirects user to OAuth provider for authentication
      parameters:
        - name: provider
          in: path
          required: true
          schema:
            type: string
            enum: [google, github, linkedin]
          description: OAuth provider
      responses:
        '302':
          description: Redirect to OAuth provider
        '400':
          description: Invalid provider
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/callback/google:
    get:
      tags:
        - Auth
      summary: Google OAuth callback
      description: Handles Google OAuth callback and sets JWT cookie
      responses:
        '302':
          description: Redirect to frontend with auth cookie set

  /api/v1/auth/callback/github:
    get:
      tags:
        - Auth
      summary: GitHub OAuth callback
      description: Handles GitHub OAuth callback and sets JWT cookie
      responses:
        '302':
          description: Redirect to frontend with auth cookie set

  /api/v1/auth/callback/linkedin:
    get:
      tags:
        - Auth
      summary: LinkedIn OAuth callback
      description: Handles LinkedIn OAuth callback and sets JWT cookie
      responses:
        '302':
          description: Redirect to frontend with auth cookie set

  /api/v1/auth/me:
    get:
      tags:
        - Auth
      summary: Get current user
      description: Returns the currently authenticated user's information
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Current user data
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    type: object
                    properties:
                      user:
                        $ref: '#/components/schemas/User'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/paid-status:
    get:
      tags:
        - Auth
      summary: Get paid subscription status
      description: Returns whether the authenticated user has an active paid subscription
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Paid status data
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    type: object
                    properties:
                      is_paid:
                        type: boolean
                        example: true
                      payment_valid_till:
                        type: string
                        format: date-time
                        nullable: true
                        example: "2026-03-01T00:00:00.000Z"
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/auth/logout:
    post:
      tags:
        - Auth
      summary: Logout user
      description: Clears the authentication cookie
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"

  /api/v1/profile:
    post:
      tags:
        - Profile
      summary: Create new profile
      description: |
        Creates a new profile for the authenticated user.
        Creates a new record each time (append-only behavior).
        Deactivates any existing active profile.
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProfileRequest'
            example:
              role: "Software Engineer"
              experience_years: 5
              company: "Tech Corp"
              country: "United States"
              name: "John Doe"
              title: "Senior Developer"
              company_type: "Startup"
              geography: "North America"
              goal: "Career growth"
      responses:
        '201':
          description: Profile created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    type: object
                    properties:
                      profile:
                        $ref: '#/components/schemas/UserProfile'
        '400':
          description: Missing required fields or validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: User not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    get:
      tags:
        - Profile
      summary: Get current profile
      description: Returns the current (active) profile for the authenticated user
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Current profile data (null if no profile exists)
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    type: object
                    properties:
                      profile:
                        oneOf:
                          - $ref: '#/components/schemas/UserProfile'
                          - type: 'null'
        '401':
          description: User not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/profile/history:
    get:
      tags:
        - Profile
      summary: Get profile history
      description: Returns all profiles (history) for the authenticated user, ordered by most recent first
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Profile history retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    type: object
                    properties:
                      profiles:
                        type: array
                        items:
                          $ref: '#/components/schemas/UserProfile'
                      count:
                        type: integer
                        description: Total number of profiles
                        example: 3
        '401':
          description: User not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/profile/check:
    get:
      tags:
        - Profile
      summary: Check if user has profile
      description: Returns whether the authenticated user has an active profile
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Profile check result
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    type: object
                    properties:
                      hasProfile:
                        type: boolean
                        example: true
        '401':
          description: User not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/questions/dimensions:
    get:
      tags:
        - Questions
      summary: Get all dimensions
      description: Returns all available assessment dimensions
      responses:
        '200':
          description: List of dimensions
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    type: object
                    properties:
                      dimensions:
                        type: array
                        items:
                          $ref: '#/components/schemas/Dimension'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/questions/roles:
    get:
      tags:
        - Questions
      summary: Get all roles
      description: Returns all available job roles for assessments
      responses:
        '200':
          description: List of roles
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    type: object
                    properties:
                      roles:
                        type: array
                        items:
                          $ref: '#/components/schemas/Role'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/assessments/start:
    post:
      tags:
        - Assessments
      summary: Start a new assessment
      description: |
        Creates a new assessment session and returns questions.
        User profile data (experience_years, company, country) is retrieved from the user's active profile.
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssessmentStartRequest'
            example:
              assessment_type: "basic"
              role: "Software Engineer"
              evaluated_dimensions:
                - dimension: "FND"
                  difficulty_level: "Basic"
                  priority: 8
                - dimension: "PRM"
                  difficulty_level: "Intermediate"
                  priority: 6
                - dimension: "ASE"
                  difficulty_level: "Basic"
                  priority: 5
              question_count: 15
      responses:
        '201':
          description: Assessment started successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    $ref: '#/components/schemas/AssessmentStartResponse'
        '401':
          description: User not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/assessments/resume:
    post:
      tags:
        - Assessments
      summary: Resume incomplete assessment
      description: Resumes the user's last incomplete assessment session
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Assessment resumed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    $ref: '#/components/schemas/AssessmentResumeResponse'
        '401':
          description: User not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: No incomplete assessment found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/assessments/save-answer:
    post:
      tags:
        - Assessments
      summary: Save an answer
      description: Saves the user's answer for a specific question
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SaveAnswerRequest'
            example:
              session_id: 1
              question_id: 101
              selected_option: "A"
      responses:
        '200':
          description: Answer saved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    type: object
                    properties:
                      is_correct:
                        type: boolean
                        example: true
                      message:
                        type: string
                        example: "Answer saved successfully"
        '400':
          description: Missing required fields or assessment already completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: User not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Invalid session or question not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/assessments/submit:
    post:
      tags:
        - Assessments
      summary: Submit assessment
      description: Marks the assessment as complete and returns the updated session
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitAssessmentRequest'
            example:
              session_id: 1
      responses:
        '200':
          description: Assessment submitted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    $ref: '#/components/schemas/AssessmentSession'
        '400':
          description: Missing session_id or assessment already completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: User not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Invalid session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/assessments/{session_id}/summary:
    get:
      tags:
        - Assessments
      summary: Get assessment summary
      description: |
        Returns assessment summary with metadata and competency breakdown.
        Validates that the assessment belongs to the authenticated user.
      security:
        - cookieAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: integer
          description: The assessment session ID
          example: 1
      responses:
        '200':
          description: Assessment summary retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    $ref: '#/components/schemas/AssessmentSummary'
        '400':
          description: Invalid session_id parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: User not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Assessment does not belong to the authenticated user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Assessment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/assessments/incomplete:
    get:
      tags:
        - Assessments
      summary: Check for incomplete assessment
      description: Checks if the authenticated user has an incomplete assessment session
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Incomplete assessment check result
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    $ref: '#/components/schemas/IncompleteAssessmentResponse'
        '401':
          description: User not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/assessments/{session_id}/reset:
    post:
      tags:
        - Assessments
      summary: Reset assessment session
      description: |
        Resets/deletes an incomplete assessment session.
        Only works for incomplete assessments owned by the authenticated user.
      security:
        - cookieAuth: []
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: integer
          description: The assessment session ID to reset
          example: 1
      responses:
        '200':
          description: Assessment session reset successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "Assessment session reset successfully"
        '400':
          description: Invalid session_id parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: User not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Assessment not found or unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/reports/basic-assessment:
    get:
      tags:
        - Reports
      summary: Get basic assessment report
      description: |
        Returns an aggregate report across all completed basic assessments for the authenticated user.
        Includes overall score and per-dimension breakdown.
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Report retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    $ref: '#/components/schemas/BasicAssessmentReport'
        '401':
          description: User not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/email/send:
    post:
      tags:
        - Email
      summary: Send enquiry email
      description: |
        Stores an enquiry email in the database. This is a fire-and-forget operation.
        The email data is saved to the enquiry_mails table for later processing.
        No authentication required.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendEmailRequest'
            example:
              to: "support@example.com"
              subject: "Question about AI Fluency"
              text: "I have a question about the assessment..."
      responses:
        '200':
          description: Email queued for delivery
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "Email queued for delivery"
        '400':
          description: Missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/study-material/{track}/{fluencyCode}/{subtopicId}:
    get:
      tags:
        - StudyMaterial
      summary: Get study material content
      description: |
        Returns study material content for a specific subtopic. Requires authentication and an active paid subscription.
      security:
        - cookieAuth: []
      parameters:
        - name: track
          in: path
          required: true
          schema:
            type: string
            enum: [EM, SE, PM]
          description: Career track
          example: PM
        - name: fluencyCode
          in: path
          required: true
          schema:
            type: string
          description: Fluency area code (e.g., FND, AGT, COM)
          example: FND
        - name: subtopicId
          in: path
          required: true
          schema:
            type: string
          description: Subtopic identifier
          example: "1.1.2"
      responses:
        '200':
          description: Study material content
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    type: object
                    description: Study material content (structure varies by subtopic)
                    additionalProperties: true
        '400':
          description: Invalid track
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Paid subscription required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Study material not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/agent/initialize:
    post:
      tags:
        - Agent
      summary: Initialize AI assessment session
      description: |
        Pre-initializes an AI Fluency Assessment session with track, experience level, and fluency selections.
        Returns a `thread_id` and `session_id` that the client uses for subsequent calls.

        **Eligibility checks** (performed before initialization):
        1. User must have an active profile.
        2. If an in-progress assessment exists, it is returned for resume (HTTP 200).
        3. A 30-day cooldown applies after a completed assessment (HTTP 409).

        Requires authentication (JWT cookie) and a paid subscription.
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentInitializeRequest'
            example:
              track: "PM"
              experience: 5
              fluencies:
                - code: "FND"
                  name: "AI Foundations & Mental Models"
                  target_level: "intermediate"
                - code: "RSK"
                  name: "AI Risk Ethics & Compliance"
                  target_level: "advanced"
      responses:
        '201':
          description: Assessment initialized successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentInitializeResponse'
        '200':
          description: Existing in-progress assessment returned for resume
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentInitializeResumeResponse'
        '400':
          description: Validation error (no active profile, malformed body, or invalid business rules)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentAssessmentValidationError'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Paid subscription required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Cooldown period active — user must wait before starting a new assessment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentCooldownError'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/agent/chat:
    post:
      tags:
        - Agent
      summary: AI Assessment Agent chat (SSE)
      description: |
        Conversational AI Fluency Assessment endpoint. Streams responses via Server-Sent Events (SSE).
        Requires authentication (JWT cookie) and a paid subscription.

        **Streaming**: The response is a `text/event-stream`. Each line is `data: <JSON>\n\n` with event objects.

        **Event types**:
        - `token` — incremental text chunk from the agent
        - `status` — processing indicator (e.g., tool execution)
        - `done` — stream complete, includes full response and assessment_id
        - `error` — error occurred during processing

        **Conversation history**: The client manages conversation history and sends it with each request.
        The agent uses persistent server-side state (file-based) keyed by `assessment_id`.
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AgentChatRequest'
            examples:
              startAssessment:
                summary: Start a pre-initialized assessment
                value:
                  message: "Start assessment"
                  thread_id: "PM_user_20260201_143022"
              resumeAssessment:
                summary: Resume an existing assessment
                value:
                  message: "Continue my assessment"
                  thread_id: "PM_user_20260201_143022"
                  conversation_history:
                    - role: "user"
                      content: "Start assessment"
                    - role: "assistant"
                      content: "Welcome to your AI Fluency Assessment..."
      responses:
        '200':
          description: SSE stream of agent responses
          content:
            text/event-stream:
              schema:
                type: string
                description: |
                  Newline-delimited SSE events. Each event is `data: <JSON>\n\n`.
              examples:
                tokenEvent:
                  summary: Token event
                  value: "data: {\"type\":\"token\",\"content\":\"Welcome to\"}\n\n"
                statusEvent:
                  summary: Status event
                  value: "data: {\"type\":\"status\",\"content\":\"processing\"}\n\n"
                doneEvent:
                  summary: Done event
                  value: "data: {\"type\":\"done\",\"content\":\"Full response text...\",\"assessmentId\":\"PM_user_20260201_143022\",\"assessmentComplete\":false}\n\n"
                errorEvent:
                  summary: Error event
                  value: "data: {\"type\":\"error\",\"content\":\"An error occurred\"}\n\n"
        '400':
          description: Missing or invalid message
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Paid subscription required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/agent/assessments:
    get:
      tags:
        - AdvancedAssessments
      summary: Get current advanced assessment
      description: |
        Returns the user's current advanced assessment summary.
        If an in-progress assessment exists, returns it. Otherwise returns the most recent completed
        assessment with cooldown information. Returns `null` data if no assessment exists.
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Current assessment data (or null if none exists)
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    oneOf:
                      - $ref: '#/components/schemas/AdvancedAssessmentSummary'
                      - type: 'null'
                  can_start_new:
                    type: boolean
                    description: Whether the user can start a new assessment (only present when data is null or absent)
              examples:
                inProgress:
                  summary: In-progress assessment
                  value:
                    data:
                      session_id: 42
                      agent_assessment_id: "PM_user_20260201_143022"
                      status: "in_progress"
                      started_at: "2026-02-01T14:30:22.000Z"
                      completed_at: null
                      total_questions_answered: 5
                      track: "PM"
                      experience: "4-7"
                      fluencies:
                        - code: "FND"
                          name: "Foundational"
                          target_level: "intermediate"
                        - code: "PRM"
                          name: "Prompting"
                          target_level: "advanced"
                      can_start_new: false
                completed:
                  summary: Completed assessment
                  value:
                    data:
                      session_id: 42
                      agent_assessment_id: "PM_user_20260201_143022"
                      status: "completed"
                      started_at: "2026-02-01T14:30:22.000Z"
                      completed_at: "2026-02-01T15:10:00.000Z"
                      total_questions_answered: 20
                      track: "PM"
                      experience: "4-7"
                      fluencies:
                        - code: "FND"
                          name: "Foundational"
                          target_level: "intermediate"
                        - code: "PRM"
                          name: "Prompting"
                          target_level: "advanced"
                      can_start_new: true
                noAssessment:
                  summary: No assessment exists
                  value:
                    data: null
                    can_start_new: true
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/agent/assessments/{sessionId}/results:
    get:
      tags:
        - AdvancedAssessments
      summary: Get assessment results with transcript
      description: |
        Returns full results and question-by-question transcript for a completed assessment session.
        Validates that the session belongs to the authenticated user and is complete.

        **Note:** `recommended_subtopics` in each fluency result is always returned as an empty array.
        Use the `POST /{sessionId}/upskill-plan` endpoint to generate a structured weekly study plan from those recommendations.
      security:
        - cookieAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: integer
          description: The assessment session ID
          example: 42
      responses:
        '200':
          description: Results and transcript returned successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      results:
                        $ref: '#/components/schemas/AssessmentOutput'
                      transcript:
                        type: array
                        items:
                          $ref: '#/components/schemas/TranscriptEntry'
        '400':
          description: Invalid session ID or assessment not yet complete
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Access denied — session belongs to another user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Assessment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/agent/assessments/{sessionId}/terminate:
    post:
      tags:
        - AdvancedAssessments
      summary: Terminate in-progress assessment
      description: |
        Terminates an in-progress advanced assessment and computes partial results.
        Unassessed modules will appear with score 1, confidence 0 in results.
        Terminated sessions can have upskill plans generated from them.
      security:
        - cookieAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: integer
          description: The assessment session ID to terminate
          example: 42
      responses:
        '200':
          description: Assessment terminated successfully with partial results
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "Assessment terminated successfully."
                  data:
                    type: object
                    properties:
                      results:
                        type: object
                        description: Partial assessment results
        '400':
          description: Invalid session ID or no matching in-progress assessment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/agent/assessments/{sessionId}/reset:
    post:
      tags:
        - AdvancedAssessments
      summary: Reset in-progress assessment
      description: |
        Resets an in-progress advanced assessment so the user can start fresh.
        Only works for assessments that are still in progress and belong to the authenticated user.
      security:
        - cookieAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: integer
          description: The assessment session ID to reset
          example: 42
      responses:
        '200':
          description: Assessment reset successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  message:
                    type: string
                    example: "Assessment reset successfully."
        '400':
          description: Invalid session ID or no matching in-progress assessment
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/agent/assessments/{sessionId}/upskill-plan:
    post:
      tags:
        - AdvancedAssessments
      summary: Create upskill plan
      description: |
        Creates a weekly upskill plan from the assessment's recommended subtopics.
        Groups subtopics into weekly study blocks (default 7 hours/week, 1 hour/subtopic, max 3 weeks).
        Items that don't fit within the specified duration are dropped (lowest priority excluded).
        Idempotent — first call creates (201), subsequent calls return existing (200).
      security:
        - cookieAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: integer
          description: The assessment session ID
          example: 42
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                max_weeks:
                  type: integer
                  minimum: 1
                  default: 3
                  description: Maximum number of weeks for the plan. Items that don't fit are dropped.
                  example: 3
                hours_per_week:
                  type: integer
                  minimum: 1
                  default: 7
                  description: Hours per week available for study. Determines items per week (hours_per_week / 1 hour per subtopic).
                  example: 7
      responses:
        '201':
          description: Plan created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UpskillPlanResponse'
        '200':
          description: Plan already exists (idempotent return)
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UpskillPlanResponse'
        '400':
          description: Assessment incomplete or no recommended subtopics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Access denied — session belongs to another user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Assessment not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    get:
      tags:
        - AdvancedAssessments
      summary: Get upskill plan
      description: |
        Returns the upskill plan for a completed assessment session, including current progress.
      security:
        - cookieAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: integer
          description: The assessment session ID
          example: 42
      responses:
        '200':
          description: Plan retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UpskillPlanResponse'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Plan or session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    patch:
      tags:
        - AdvancedAssessments
      summary: Update upskill plan
      description: |
        Updates plan-level fields such as `is_active`. Returns the full updated plan.
      security:
        - cookieAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: integer
          description: The assessment session ID
          example: 42
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                is_active:
                  type: boolean
                  description: Set to false to deactivate the plan
                  example: false
      responses:
        '200':
          description: Plan updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/UpskillPlanResponse'
        '400':
          description: No valid fields to update or assessment incomplete
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Plan or session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/preview-access:
    post:
      tags:
        - Preview Access
      summary: Request preview access
      description: |
        Submit a request for preview feature access. Returns 409 if a request already exists for the authenticated user.
      security:
        - cookieAuth: []
      responses:
        '201':
          description: Preview access request created
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "success"
                  data:
                    type: object
                    properties:
                      id:
                        type: integer
                        example: 1
                      user_id:
                        type: integer
                        example: 123
                      request_date:
                        type: string
                        format: date-time
                      is_granted:
                        type: boolean
                        example: false
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Preview access request already exists
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "fail"
                  message:
                    type: string
                    example: "Preview access request already exists."

  /api/v1/agent/assessments/{sessionId}/upskill-plan/items:
    patch:
      tags:
        - AdvancedAssessments
      summary: Bulk mark plan items as done
      description: |
        Marks one or more upskill plan items as completed. Only updates items that are currently pending.
      security:
        - cookieAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: integer
          description: The assessment session ID
          example: 42
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - item_ids
              properties:
                item_ids:
                  type: array
                  items:
                    type: integer
                  description: IDs of plan items to mark as done
                  example: [1, 3, 5]
      responses:
        '200':
          description: Items updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      updated_count:
                        type: integer
                        description: Number of items that were updated
                        example: 3
        '400':
          description: Invalid item_ids or assessment incomplete
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Access denied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Plan or session not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: token
      description: JWT token stored in cookie after OAuth login

  schemas:
    Error:
      type: object
      properties:
        status:
          type: string
          example: "error"
        message:
          type: string
          example: "Error message"

    SendEmailRequest:
      type: object
      required:
        - to
        - subject
      properties:
        to:
          type: string
          format: email
          description: Recipient email address
          example: "support@example.com"
        subject:
          type: string
          description: Email subject
          example: "Question about AI Fluency"
        text:
          type: string
          description: Plain text email body (required if html not provided)
          example: "I have a question about the assessment..."
        html:
          type: string
          description: HTML email body (required if text not provided)
          example: "<p>I have a question about the assessment...</p>"

    User:
      type: object
      properties:
        id:
          type: string
          example: "123"
        loginId:
          type: string
          example: "google-oauth-id"
        name:
          type: string
          example: "John Doe"
        provider:
          type: string
          enum: [google, github, linkedin]
          example: "google"
        is_paid:
          type: boolean
          nullable: true
          example: null
        payment_valid_till:
          type: string
          format: date-time
          nullable: true
          example: null

    CreateProfileRequest:
      type: object
      required:
        - role
        - experience_years
        - company
        - country
      properties:
        role:
          type: string
          description: Job role
          example: "Software Engineer"
        experience_years:
          type: integer
          description: Years of experience
          example: 5
        company:
          type: string
          description: Company name
          example: "Tech Corp"
        country:
          type: string
          description: Country
          example: "United States"
        name:
          type: string
          description: User's display name (optional)
          example: "John Doe"
        title:
          type: string
          description: Job title (optional)
          example: "Senior Developer"
        company_type:
          type: string
          description: Type of company (optional)
          example: "Startup"
        geography:
          type: string
          description: Geographic region (optional)
          example: "North America"
        goal:
          type: string
          description: Career goal (optional)
          example: "Career growth"
        metadata:
          type: object
          description: Additional metadata (optional)
          additionalProperties: true

    UserProfile:
      type: object
      properties:
        profile_id:
          type: integer
          description: Unique profile identifier
          example: 1
        user_id:
          type: integer
          description: User ID this profile belongs to
          example: 123
        name:
          type: string
          nullable: true
          example: "John Doe"
        role:
          type: string
          example: "Software Engineer"
        title:
          type: string
          nullable: true
          example: "Senior Developer"
        experience_years:
          type: integer
          example: 5
        company:
          type: string
          example: "Tech Corp"
        country:
          type: string
          example: "United States"
        company_type:
          type: string
          nullable: true
          example: "Startup"
        geography:
          type: string
          nullable: true
          example: "North America"
        goal:
          type: string
          nullable: true
          example: "Career growth"
        is_active:
          type: boolean
          description: Whether this is the current active profile
          example: true
        metadata:
          type: object
          nullable: true
          additionalProperties: true
        created_at:
          type: string
          format: date-time

    IncompleteAssessmentResponse:
      type: object
      properties:
        has_incomplete:
          type: boolean
          description: Whether user has an incomplete assessment
          example: true
        session:
          type: object
          nullable: true
          description: Session details if incomplete assessment exists
          properties:
            session_id:
              type: integer
              example: 1
            assessment_type:
              type: string
              enum: [basic, advanced]
              example: "basic"
            started_at:
              type: string
              format: date-time
            answered_count:
              type: integer
              description: Number of questions already answered
              example: 5
            total_questions:
              type: integer
              description: Total questions in the assessment
              example: 15

    Dimension:
      type: object
      properties:
        dimension_id:
          type: integer
          example: 1
        dimension_code:
          type: string
          enum: [FND, PRM, ASE, ETH, COL]
          example: "FND"
        name:
          type: string
          example: "Foundational"
        description:
          type: string
          example: "Core AI/ML concepts and fundamentals"
        display_order:
          type: integer
          example: 1
        created_at:
          type: string
          format: date-time

    Role:
      type: object
      properties:
        role_id:
          type: integer
          example: 1
        name:
          type: string
          example: "Software Engineer"
        created_at:
          type: string
          format: date-time

    Question:
      type: object
      properties:
        question_id:
          type: integer
          example: 101
        question_text:
          type: string
          example: "What is the primary purpose of a neural network?"
        difficulty_level:
          type: string
          enum: [Basic, Intermediate, Advanced, Expert]
          example: "Basic"
        dimension:
          type: string
          enum: [FND, PRM, ASE, ETH, COL]
          example: "FND"
        option_a:
          type: string
          example: "To store data"
        option_b:
          type: string
          example: "To learn patterns from data"
        option_c:
          type: string
          example: "To connect computers"
        option_d:
          type: string
          example: "To encrypt information"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    QuestionWithState:
      allOf:
        - $ref: '#/components/schemas/Question'
        - type: object
          properties:
            is_answered:
              type: boolean
              example: false
            selected_option:
              type: string
              enum: [A, B, C, D, null]
              nullable: true
              example: null

    EvaluatedDimension:
      type: object
      required:
        - dimension
        - difficulty_level
        - priority
      properties:
        dimension:
          type: string
          enum: [FND, PRM, ASE, ETH, COL]
          description: |
            Dimension code:
            - FND: Foundational
            - PRM: Prompting
            - ASE: AI-assisted Software Engineering
            - ETH: Ethics
            - COL: Collaboration
          example: "FND"
        difficulty_level:
          type: string
          enum: [Basic, Intermediate, Advanced, Expert]
          example: "Basic"
        priority:
          type: integer
          description: Priority level for this dimension (1-10, where 10 = highest priority)
          minimum: 1
          maximum: 10
          example: 8

    AssessmentStartRequest:
      type: object
      required:
        - assessment_type
        - role
        - evaluated_dimensions
        - question_count
      properties:
        assessment_type:
          type: string
          enum: [basic, advanced]
          example: "basic"
        role:
          type: string
          example: "Software Engineer"
        evaluated_dimensions:
          type: array
          items:
            $ref: '#/components/schemas/EvaluatedDimension'
          minItems: 1
        question_count:
          type: integer
          example: 15

    AssessmentStartResponse:
      type: object
      properties:
        session_id:
          type: integer
          example: 1
        assessment_type:
          type: string
          enum: [basic, advanced]
          example: "basic"
        started_at:
          type: string
          format: date-time
        questions:
          type: array
          items:
            $ref: '#/components/schemas/Question'

    AssessmentResumeResponse:
      type: object
      properties:
        session_id:
          type: integer
          example: 1
        assessment_type:
          type: string
          enum: [basic, advanced]
          example: "basic"
        started_at:
          type: string
          format: date-time
        questions:
          type: array
          items:
            $ref: '#/components/schemas/QuestionWithState'
        answered_count:
          type: integer
          example: 5
        total_questions:
          type: integer
          example: 15

    SaveAnswerRequest:
      type: object
      required:
        - session_id
        - question_id
        - selected_option
      properties:
        session_id:
          type: integer
          example: 1
        question_id:
          type: integer
          example: 101
        selected_option:
          type: string
          enum: [A, B, C, D]
          example: "A"

    SubmitAssessmentRequest:
      type: object
      required:
        - session_id
      properties:
        session_id:
          type: integer
          example: 1

    DimensionScores:
      type: object
      additionalProperties:
        type: integer
        minimum: 0
        maximum: 100
      example:
        FND: 80
        PRM: 65
        ASE: 90

    AssessmentResults:
      type: object
      properties:
        session_id:
          type: integer
          example: 1
        total_questions:
          type: integer
          example: 15
        dimension_scores:
          $ref: '#/components/schemas/DimensionScores'
        completed_at:
          type: string
          format: date-time

    BasicAssessmentReport:
      type: object
      properties:
        user_id:
          type: integer
          example: 123
        total_assessments:
          type: integer
          description: Total number of completed basic assessments
          example: 5
        total_questions:
          type: integer
          description: Total questions answered across all basic assessments
          example: 75
        total_correct:
          type: integer
          description: Total correct answers across all basic assessments
          example: 60
        overall_score_percentage:
          type: integer
          description: Overall accuracy percentage
          minimum: 0
          maximum: 100
          example: 80
        dimension_scores:
          type: array
          description: Per-dimension breakdown
          items:
            $ref: '#/components/schemas/DimensionScoreBreakdown'

    DimensionScoreBreakdown:
      type: object
      properties:
        dimension:
          type: string
          description: Dimension code
          example: "FND"
        total_questions:
          type: integer
          description: Total questions for this dimension
          example: 15
        correct_answers:
          type: integer
          description: Correct answers for this dimension
          example: 12
        score_percentage:
          type: integer
          description: Accuracy percentage for this dimension
          minimum: 0
          maximum: 100
          example: 80
        difficulty_level:
          type: string
          description: Difficulty level from the most recent assessment
          enum: [Basic, Intermediate, Advanced, Expert]
          example: "Intermediate"

    AssessmentSession:
      type: object
      properties:
        session_id:
          type: integer
          example: 1
        user_id:
          type: integer
          example: 123
        assessment_type:
          type: string
          enum: [basic, advanced]
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        is_complete:
          type: boolean
          description: Whether the assessment has been completed
          example: true
        metadata:
          $ref: '#/components/schemas/AssessmentMetadata'

    FluencyInput:
      type: object
      required:
        - experience_years
        - role
        - company
        - country
      properties:
        experience_years:
          type: integer
          description: Years of experience
          example: 5
        role:
          type: string
          example: "Software Engineer"
        title:
          type: string
          example: "Senior Developer"
        company:
          type: string
          example: "Tech Corp"
        country:
          type: string
          example: "United States"
        company_type:
          type: string
          example: "Startup"
        geography:
          type: string
          example: "North America"
        goal:
          type: string
          example: "Career growth"
        min_fluency_level:
          type: string
          enum: [Basic, Intermediate, Advanced, Expert]
          description: |
            Optional filter to return only dimensions at or above this fluency level.
            - Basic: return all dimensions
            - Intermediate: exclude Basic level dimensions
            - Advanced: exclude Basic and Intermediate level dimensions
            - Expert: return only Expert level dimensions
          example: "Intermediate"

    FluencyProfileV1:
      type: object
      properties:
        profile:
          type: array
          items:
            $ref: '#/components/schemas/DimensionProfileV1'
        metadata:
          $ref: '#/components/schemas/FluencyMetadata'

    FluencyProfileV2:
      type: object
      properties:
        profile:
          type: array
          items:
            $ref: '#/components/schemas/DimensionProfileV2'
        metadata:
          $ref: '#/components/schemas/FluencyMetadata'

    DimensionProfileV1:
      type: object
      properties:
        code:
          type: string
          description: Dimension code (e.g., FND, PRM, ASE)
          example: "FND"
        name:
          type: string
          description: Full name of the dimension
          example: "AI Foundations & Mental Models"
        description:
          type: string
          description: Description of the dimension
          example: "Understanding of AI capabilities and limitations"
        proficiency:
          type: string
          enum: [Basic, Intermediate, Advanced, Expert]
          example: "Intermediate"

    DimensionProfileV2:
      type: object
      properties:
        code:
          type: string
          description: Dimension code (e.g., FND, PRM, ASE)
          example: "PRM"
        name:
          type: string
          description: Full name of the dimension
          example: "Prompting & Human-AI Interaction"
        description:
          type: string
          description: Description of the dimension
          example: "Effective communication with AI systems"
        proficiency:
          type: string
          enum: [Basic, Intermediate, Advanced, Expert]
          example: "Intermediate"
        priority:
          type: integer
          minimum: 1
          maximum: 10
          description: Priority ranking for this dimension (1 = highest priority, 10 = lowest)
          example: 1

    FluencyMetadata:
      type: object
      properties:
        experience:
          type: integer
          description: Years of experience
          example: 5
        role:
          type: string
          example: "software engineer"
        company:
          type: string
          example: "Tech Corp"
        country:
          type: string
          example: "US"
        goal:
          type: string
          nullable: true
          example: null

    CompetencyBreakdown:
      type: object
      properties:
        dimension:
          type: string
          description: Dimension/competency code
          example: "FND"
        total_questions:
          type: integer
          description: Total number of questions in this competency
          example: 6
        correct_answers:
          type: integer
          description: Number of correctly answered questions in this competency
          example: 5

    AssessmentMetadata:
      type: object
      properties:
        experience_years:
          type: integer
          example: 5
        company:
          type: string
          example: "Tech Corp"
        country:
          type: string
          example: "United States"
        role:
          type: string
          example: "backend engineer"
      additionalProperties: true

    AssessmentSummary:
      type: object
      properties:
        session_id:
          type: integer
          example: 1
        assessment_type:
          type: string
          enum: [basic, advanced]
          example: "basic"
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
          nullable: true
        metadata:
          $ref: '#/components/schemas/AssessmentMetadata'
        total_questions:
          type: integer
          description: Total number of questions in the assessment
          example: 30
        total_correct:
          type: integer
          description: Total number of correctly answered questions
          example: 22
        competency_breakdown:
          type: array
          description: Breakdown of questions and correct answers per competency
          items:
            $ref: '#/components/schemas/CompetencyBreakdown'
          example:
            - dimension: "FND"
              total_questions: 6
              correct_answers: 5
            - dimension: "PRM"
              total_questions: 6
              correct_answers: 4
            - dimension: "ASE"
              total_questions: 6
              correct_answers: 5

    AgentChatRequest:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: The user's message to the assessment agent
          example: "Start assessment"
        thread_id:
          type: string
          nullable: true
          description: Thread ID (assessment ID) from POST /api/v1/agent/initialize. Required to start or resume a session.
          example: "PM_user_20260201_143022"
        conversation_history:
          type: array
          description: Previous conversation messages (client-managed). Send full history each request.
          items:
            $ref: '#/components/schemas/AgentConversationMessage'

    AgentConversationMessage:
      type: object
      required:
        - role
        - content
      properties:
        role:
          type: string
          enum: [user, assistant]
          description: Who sent this message
          example: "user"
        content:
          type: string
          description: Message content
          example: "Start assessment"

    AgentSSEEvent:
      type: object
      required:
        - type
        - content
      properties:
        type:
          type: string
          enum: [token, status, done, error]
          description: |
            Event type:
            - `token`: Incremental text chunk from the agent
            - `status`: Processing indicator (e.g., tool execution in progress)
            - `done`: Stream complete with full response
            - `error`: Error occurred during processing
          example: "token"
        content:
          type: string
          description: Event payload (text chunk, status message, full response, or error message)
          example: "Welcome to your AI Fluency Assessment"
        assessmentId:
          type: string
          nullable: true
          description: Assessment ID (included in `done` events)
          example: "PM_user_20260201_143022"
        assessmentComplete:
          type: boolean
          nullable: true
          description: Whether the assessment has reached the DONE phase. Included in `done` events. When true, the client should end the conversation.
          example: false

    AgentInitializeRequest:
      type: object
      required:
        - track
        - experience
        - fluencies
      properties:
        track:
          type: string
          enum: [PM, EM, SE]
          description: Career track for the assessment
          example: "PM"
        experience:
          type: integer
          minimum: 0
          description: Years of experience (will be mapped to appropriate experience range internally)
          example: 5
        fluencies:
          type: array
          description: Fluency areas to assess (1-10)
          minItems: 1
          maxItems: 10
          items:
            $ref: '#/components/schemas/AgentFluencyInput'

    AgentFluencyInput:
      type: object
      required:
        - code
        - name
        - target_level
      properties:
        code:
          type: string
          description: Fluency code (e.g., FND, RSK, COM)
          example: "FND"
        name:
          type: string
          description: Human-readable fluency name
          example: "AI Foundations & Mental Models"
        target_level:
          type: string
          enum: [basic, intermediate, advanced, expert]
          description: Target proficiency level for this fluency
          example: "intermediate"

    AgentInitializeResponse:
      type: object
      properties:
        status:
          type: string
          example: "success"
        data:
          type: object
          properties:
            thread_id:
              type: string
              description: Unique assessment thread ID. Use this in subsequent POST /api/v1/agent/chat requests.
              example: "PM_user_20260201_143022"
            session_id:
              type: integer
              description: Database session ID linking the assessment to the user's profile
              example: 42

    AgentInitializeResumeResponse:
      type: object
      properties:
        status:
          type: string
          example: "success"
        data:
          type: object
          properties:
            thread_id:
              type: string
              description: Existing assessment thread ID to resume
              example: "PM_user_20260201_143022"
            session_id:
              type: integer
              description: Existing DB session ID
              example: 42
            resumed:
              type: boolean
              description: Always true — indicates this is a resumed assessment
              example: true

    AgentCooldownError:
      type: object
      properties:
        error_type:
          type: string
          example: "cooldown_active"
        message:
          type: string
          example: "Assessment cooldown period active."
        cooldown_ends_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp when the cooldown expires
          example: "2026-03-03T15:10:00.000Z"

    AgentAssessmentValidationError:
      type: object
      properties:
        error_type:
          type: string
          description: Error classification
          example: "validation_error"
        message:
          type: string
          description: Human-readable error description
          example: "Invalid experience '99-100' for track PM. Valid levels: 0-2, 2-4, 4-7, 7-10, 10-14, 14-18, 18+"
        invalid_fields:
          type: array
          description: Field paths that failed validation
          items:
            type: string
          example: ["assessment_input.experience"]

    AdvancedAssessmentSummary:
      type: object
      properties:
        session_id:
          type: integer
          description: Database session ID
          example: 42
        agent_assessment_id:
          type: string
          description: Agent assessment thread ID
          example: "PM_user_20260201_143022"
        status:
          type: string
          enum: [in_progress, completed, terminated]
          description: Current assessment status
          example: "in_progress"
        started_at:
          type: string
          format: date-time
          example: "2026-02-01T14:30:22.000Z"
        completed_at:
          type: string
          format: date-time
          nullable: true
          description: Null if still in progress
          example: null
        total_questions_answered:
          type: integer
          description: Number of questions answered so far
          example: 5
        track:
          type: string
          description: Career track (PM, EM, SE)
          example: "PM"
        experience:
          type: string
          description: Experience range string
          example: "4-7"
        fluencies:
          type: array
          description: Fluency areas being assessed with target proficiency levels
          items:
            type: object
            properties:
              code:
                type: string
                description: Fluency code (e.g. FND, PRM, ASE)
                example: "FND"
              name:
                type: string
                description: Human-readable fluency name
                example: "Foundational"
              target_level:
                type: string
                enum: [basic, intermediate, advanced, expert]
                description: Target proficiency level for this fluency
                example: "intermediate"
        can_start_new:
          type: boolean
          description: Whether the user can start a new assessment
          example: false

    AssessmentOutput:
      type: object
      description: Full assessment results computed at completion
      required:
        - metadata
        - fluency_results
        - overall_summary
      properties:
        metadata:
          $ref: '#/components/schemas/AssessmentOutputMetadata'
        fluency_results:
          type: array
          items:
            $ref: '#/components/schemas/FluencyResult'
        overall_summary:
          type: string
          description: Human-readable summary of the assessment outcome
          example: "Strong foundations with room to grow in applied ML."

    AssessmentOutputMetadata:
      type: object
      required:
        - assessment_id
        - track
        - experience
        - started_at
        - completed_at
        - total_questions_asked
        - fluencies_assessed
      properties:
        assessment_id:
          type: string
          example: "abc-123"
        track:
          type: string
          example: "AI Engineer"
        experience:
          type: string
          example: "mid"
        started_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time
        total_questions_asked:
          type: integer
          example: 15
        fluencies_assessed:
          type: integer
          example: 3

    FluencyResult:
      type: object
      required:
        - code
        - name
        - target_level
        - demonstrated_level
        - modules
        - recommended_subtopics
      properties:
        code:
          type: string
          example: "FND"
        name:
          type: string
          example: "AI Foundations"
        target_level:
          type: string
          enum: [beginner, intermediate, advanced, expert]
        demonstrated_level:
          type: string
          enum: [beginner, intermediate, advanced, expert, not_demonstrated, insufficient_data]
        modules:
          type: array
          items:
            $ref: '#/components/schemas/ModuleResult'
        recommended_subtopics:
          type: array
          description: Always returned as an empty array in the results API. Use the upskill-plan endpoint to access study recommendations.
          items:
            $ref: '#/components/schemas/RecommendedSubtopic'

    ModuleResult:
      type: object
      required:
        - module_id
        - module_title
        - aggregate_score
        - demonstrated_level
        - assessed
        - subtopic_results
        - is_focus_area
      properties:
        module_id:
          type: string
          example: "FND-M1"
        module_title:
          type: string
          example: "Neural Networks"
        aggregate_score:
          type: number
          description: Aggregate score across subtopics (0-3)
          example: 2.1
        demonstrated_level:
          type: string
          enum: [beginner, intermediate, advanced, expert, not_demonstrated, insufficient_data]
        assessed:
          type: boolean
          description: Whether this module was actually assessed (false for unassessed/terminated modules)
          example: true
        subtopic_results:
          type: array
          description: Per-subtopic score breakdown
          items:
            $ref: '#/components/schemas/SubtopicResult'
        is_focus_area:
          type: boolean

    SubtopicResult:
      type: object
      required:
        - subtopic_id
        - title
        - level
        - score
        - confidence
        - assessed
      properties:
        subtopic_id:
          type: string
          example: "1.1.2"
        title:
          type: string
          example: "Agent Architecture Patterns"
        level:
          type: string
          enum: [beginner, intermediate, advanced, expert]
          example: "intermediate"
        score:
          type: number
          description: Score for this subtopic (0-3)
          example: 2.0
        confidence:
          type: number
          description: Confidence level (0.0-1.0)
          example: 0.8
        assessed:
          type: boolean
          description: Whether this subtopic was actually assessed
          example: true

    RecommendedSubtopic:
      type: object
      required:
        - subtopic_id
        - title
        - level
        - module_id
        - priority
      properties:
        subtopic_id:
          type: string
          example: "FND-M1-S2"
        title:
          type: string
          example: "Backpropagation"
        level:
          type: string
          enum: [beginner, intermediate, advanced, expert]
        module_id:
          type: string
          example: "FND-M1"
        priority:
          type: integer
          example: 1
        gap_type:
          type: string
          enum: [no_signal, surface_only, below_target, unassessed]
          description: Type of gap identified for this subtopic
          example: "below_target"
        score:
          type: number
          nullable: true
          description: Subtopic score (0-3) if assessed
          example: 1.5
        confidence:
          type: number
          nullable: true
          description: Confidence level (0.0-1.0) if assessed
          example: 0.7

    TranscriptEntry:
      type: object
      properties:
        question_number:
          type: integer
          description: Sequential question number in the assessment
          example: 1
        fluency_code:
          type: string
          description: Fluency area code
          example: "FND"
        module_id:
          type: string
          description: Module identifier
          example: "FND-M1"
        subtopic_title:
          type: string
          nullable: true
          description: Subtopic title if applicable
          example: "Neural Network Basics"
        asked_at_level:
          type: string
          description: Difficulty level the question was asked at
          example: "intermediate"
        question_text:
          type: string
          description: The question that was asked
          example: "Explain how gradient descent optimizes a neural network."
        user_response:
          type: string
          description: The user's answer
          example: "Gradient descent adjusts weights by..."
        expected_good_response:
          type: string
          nullable: true
          description: Reference answer for comparison
        score:
          type: number
          nullable: true
          description: Score assigned to the response (0-10)
          example: 7
        score_justification:
          type: string
          nullable: true
          description: Explanation for the score
          example: "Good understanding of the core concept but missed..."
        module_scores:
          type: object
          nullable: true
          description: Per-module score breakdown (if fluency-based strategy)
          additionalProperties:
            type: number

    UpskillPlanResponse:
      type: object
      properties:
        plan_id:
          type: integer
          example: 1
        session_id:
          type: integer
          example: 42
        total_items:
          type: integer
          example: 18
        total_weeks:
          type: integer
          example: 3
        hours_per_week:
          type: integer
          example: 6
        is_active:
          type: boolean
          description: Whether the plan is active
          example: true
        track:
          type: string
          description: Career track (PM, EM, SE)
          example: "PM"
        progress:
          type: object
          properties:
            completed:
              type: integer
              example: 0
            remaining:
              type: integer
              example: 18
            percentage:
              type: integer
              example: 0
        weeks:
          type: array
          items:
            $ref: '#/components/schemas/UpskillWeek'
        created_at:
          type: string
          format: date-time

    UpskillWeek:
      type: object
      properties:
        week_number:
          type: integer
          example: 1
        items:
          type: array
          items:
            $ref: '#/components/schemas/UpskillPlanItem'

    UpskillPlanItem:
      type: object
      properties:
        item_id:
          type: integer
          example: 1
        fluency_code:
          type: string
          example: "AGT"
        fluency_name:
          type: string
          example: "Agentic AI Systems"
        module_id:
          type: string
          example: "1"
        module_title:
          type: string
          example: "Foundations of Agentic AI"
        subtopic_id:
          type: string
          example: "1.1.2"
        subtopic_title:
          type: string
          example: "Agent Architecture Patterns"
        level:
          type: string
          example: "intermediate"
        priority:
          type: integer
          example: 1
        status:
          type: string
          enum: [pending, done]
          example: "pending"
        completed_at:
          type: string
          format: date-time
          nullable: true
        rationale:
          type: string
          nullable: true
          description: Explanation of why this subtopic was recommended
          example: "Scored below threshold on agent architecture concepts"
